version: '3.8'

services:
  frontend-prod:
    env_file:
      - .env
    build:
      context: GPTutor-Frontend-v2
      dockerfile: Dockerfile
      args:
        VITE_API_URL: 'https://api.${HOST}'
        VITE_VK_APP_ID: '${VK_APP_ID}'
    container_name: frontend-prod
    labels:
      - "traefik.enable=true"
      - "traefik.http.routers.frontend-prod.rule=Host(`front.${HOST}`)"
      - "traefik.http.routers.frontend-prod.entrypoints=websecure"
      - "traefik.http.routers.frontend-prod.tls.certresolver=myresolver"
    networks:
      - trfk
    restart: unless-stopped

  backend-prod:
    env_file:
      - .env
      - .env-prod
    build:
      context: ./GPTutor-Backend-v2
      dockerfile: Dockerfile
    container_name: backend-prod
    environment:
      - NODE_ENV=production
      - PORT=3001
      - DATABASE_URL=file:./prod.db

    volumes:
      - backend-db:/app/prisma
      - backend-logs:/app/logs
    labels:
      - "traefik.enable=true"
      - "traefik.http.routers.backend-prod.rule=Host(`api.${HOST}`)"
      - "traefik.http.routers.backend-prod.entrypoints=websecure"
      - "traefik.http.routers.backend-prod.tls.certresolver=myresolver"
      - "traefik.http.services.backend-prod.loadbalancer.server.port=3001"
    networks:
      - trfk
    restart: unless-stopped

  docs-prod:
    build:
      context: ./GPTutor-Backend-v2/docs
      dockerfile: Dockerfile
    container_name: docs-prod
    labels:
      - "traefik.enable=true"
      - "traefik.http.routers.docs-prod.rule=Host(`docs.${HOST}`)"
      - "traefik.http.routers.docs-prod.entrypoints=websecure"
      - "traefik.http.routers.docs-prod.tls.certresolver=myresolver"
      - "traefik.http.services.docs-prod.loadbalancer.server.port=8080"
    networks:
      - trfk
    restart: unless-stopped

volumes:
  backend-db:
    driver: local
  backend-logs:
    driver: local

networks:
  trfk:
    driver: bridge
